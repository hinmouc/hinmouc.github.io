name: Deploy Complete Site

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
      - 'Desk/**'
      - 'index.html'

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Dependencies
        working-directory: ./Desk
        run: |
          pip install mkdocs-material
          pip install mkdocs-git-revision-date-localized-plugin
          pip install mkdocs-git-authors-plugin
          pip install mkdocs-git-committers-plugin-2
          pip install markdown-callouts
          pip install mkdocs-rss-plugin
          pip install pymdown-extensions

      - name: Build MkDocs to Temporary Directory
        working-directory: ./Desk
        run: |
          mkdocs build --site-dir desk_temp

      - name: Prepare Final Site Structure
        run: |
          # 1. 创建最终输出目录
          mkdir -p ./Desk/site
          # 2. 移动文档站到子目录
          mv ./Desk/desk_temp ./Desk/site/desk
          
          echo "开始同步根目录所有文件到发布目录..."
          
          # 3. 【核心修正】使用 find 和 cp 命令代替 rsync，兼容性更好
          # 原理：复制当前目录(.)下所有文件和文件夹，排除指定的几个
          find . -maxdepth 1 \
            -not -name '.' \
            -not -name '.git' \
            -not -name '.github' \
            -not -name 'Desk' \
            -not -name 'Desk/site' \
            -exec cp -r {} ./Desk/site/ \;
          
          echo "同步完成。最终发布结构已准备完毕。"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./Desk/site
          keep_files: false