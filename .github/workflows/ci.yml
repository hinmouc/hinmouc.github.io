name: Deploy Complete Site

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
      - 'Desk/**'               
      - 'index.html'           

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Dependencies
        working-directory: ./Desk
        run: |
          pip install mkdocs-material
          pip install mkdocs-git-revision-date-localized-plugin
          pip install mkdocs-git-authors-plugin
          pip install mkdocs-git-committers-plugin-2
          pip install markdown-callouts
          pip install mkdocs-rss-plugin
          pip install pymdown-extensions

      - name: Build MkDocs to Temporary Directory
        working-directory: ./Desk
        run: |
          mkdocs build --site-dir desk_temp

      - name: Prepare Final Site Structure
        run: |
          # 1. 创建最终输出目录 Desk/site
          mkdir -p ./Desk/site
          # 2. 将构建好的文档站移动到 Desk/site/desk
          mv ./Desk/desk_temp ./Desk/site/desk
          
          echo “开始同步根目录所有文件到发布目录...”
          # *** 修改点 2：使用 rsync 同步整个根目录 ***
          # 原因：原来的 cp 命令只复制了明确列出的几个简历文件，无法满足
          #       “自动包含其他项目（如 PIVFusion）”的需求。
          # 作用：此命令将仓库根目录下所有内容（除排除项外）同步到 Desk/site/，
          #       实现您的需求1（简历文件）和需求3（其他项目）。
          rsync -av \
            --exclude='.git' \       # 排除版本控制目录
            --exclude='.github' \    # 排除 CI 配置目录
            --exclude='Desk' \       # 排除 MkDocs 源码目录，因其产物已在 desk 文件夹内
            --exclude='Desk/site' \  # 排除目标目录自身，防止循环
            ./ \
            ./Desk/site/
          
          echo “同步完成。最终发布结构已准备完毕。”

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./Desk/site
          keep_files: false